---
apiVersion: keycloak.org/v1alpha1
kind: Keycloak
metadata:
  name: kuberlogic-keycloak
  labels:
    app: sso
spec:
  instances: 1
  extensions:
    - https://github.com/aerogear/keycloak-metrics-spi/releases/download/1.0.4/keycloak-metrics-spi-1.0.4.jar
  externalAccess:
    enabled: False
  podDisruptionBudget:
    enabled: False
  externalDatabase:
    enabled: False
---
apiVersion: keycloak.org/v1alpha1
kind: KeycloakRealm
metadata:
  name: kuberlogic
  labels:
    app: sso
spec:
  realm:
    id: "kuberlogic_realm"
    realm: "kuberlogic_realm"
    accessTokenLifespan: 3600
    accessTokenLifespanForImplicitFlow: 3600
    registrationAllowed: false
    enabled: true
    displayName: "Kuberlogic"
    eventsListeners:
      - "metrics-listener"
    userManagedAccessAllowed: true
    users:
      - username: "realm_admin"
        firstName: "John"
        lastName: "Doe"
        email: "admin@example.com"
        enabled: True
        emailVerified: False
        credentials:
          - type: password
            value: secret
            temporary: false
        realmRoles:
          - "offline_access"
          - "uma_authorization"
          - "uma_protection"
        clientRoles:
          account:
            - "manage-account"
            - "view-profile"
          realm-management:
            - "manage-users"
            - "view-users"
            - "query-users"
            - "create-client"
  instanceSelector:
    matchLabels:
      app: sso
---
apiVersion: keycloak.org/v1alpha1
kind: KeycloakClient
metadata:
  name: apiserver
  labels:
    app: sso
spec:
  realmSelector:
    matchLabels:
      app: sso
  client:
    clientId: apiserver
    secret: apiserver-secret
    clientAuthenticatorType: client-secret
    protocol: openid-connect
    directAccessGrantsEnabled: true
    serviceAccountsEnabled: true
    authorizationServicesEnabled: true
    authorizationSettings:
      allowRemoteResourceManagement: true
      resources:
        - name: "4f6b97e729327473139acd2748457f44:*"
          type: kuberlogicservice
          scopes:
            - name: "service:*"
      policies:
        - name: kuberlogic-test-allow
          type: user
          logic: POSITIVE
          config:
            users: '["kuberlogic-test-user"]'
        - name: test-ns-full
          type: scope
          decisionStrategy: UNANIMOUS
          config:
            applyPolicies: '["kuberlogic-test-allow"]'
            scopes: '["service:*"]'
            resources: '["4f6b97e729327473139acd2748457f44:*"]'
    protocolMappers:
      - name: "apiserver-aud"
        protocol: "openid-connect"
        consentRequired: false
        protocolMapper: "oidc-audience-mapper"
        config:
          included.client.audience: "apiserver"
          access.token.claim: "true"
    defaultRoles:
      - "uma_protection"
    defaultClientScopes:
      - email
      - profile
      - roles
      - offline_access
      - web-origins
    optionalClientScopes:
      - email
      - profile
      - roles
      - offline_access
      - web-origins
---
apiVersion: keycloak.org/v1alpha1
kind: KeycloakUser
metadata:
  name: kuberlogic-test-user
  labels:
    app: sso
spec:
  realmSelector:
    matchLabels:
      app: sso
  user:
    credentials:
    - type: password
      value: secret
      temporary: false
    email: keycloak@example.com
    id: kuberlogic-test-user
    username: kuberlogic-test-user
    enabled: true
    firstName: kuberlogic
    lastName: system
    realmRoles:
      - "offline_access"
      - "uma_authorization"
    clientRoles:
      account:
        - manage-account
        - view-profile
